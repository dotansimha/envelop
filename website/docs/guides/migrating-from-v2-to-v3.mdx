# Migrating from `v2` to `v3`

With [new major version](https://github.com/n1ru4l/envelop/pull/1487) comes breaking changes. This section will guide you through the process of migrating from `v2` to `v3`.

### 1. Remove `graphql` as a peer dependency

We have designed the new `envelop` to be engine agnostic. This allows you to use any GraphQL engine you want. This means that `graphql` is no longer a peer dependency and `envelop` simply just wraps the `parse`, `validate`, `execute` and `subscribe` functions that you provide.

```diff
import { envelop } from '@envelop/core';
+ import { parse, validate, execute, subscribe } from 'graphql';

- const getEnveloped = envelop([ ... ])
+ const getEnveloped = envelop({ parse, validate, execute, subscribe, plugins: [ ... ] })
```

### 2. Removed orchestrator tracing

We were wrapping the `GraphQLSchema` object but with the new version we no longer want to depend on a specific implementation.

#### 1. Remove `onResolverCalled`

We decided to drop this and instead [provide a new plugin](https://github.com/n1ru4l/envelop/pull/1500) that will let you hook into this phase.

```diff
import { parse, validate, execute, subscribe } from 'graphql'
import { envelop, Plugin } from '@envelop/core'
+ import { useOnResolve } from '@envelop/on-resolve'

import { onResolverCalled } from './my-resolver'

function useResolve(): Plugin {
  return {
-   onResolverCalled: onResolverCalled,
+   onPluginInit: ({ addPlugin }) => {
+     addPlugin(useOnResolve(onResolverCalled))
+   },
  }
}

const getEnveloped = envelop({
  parse,
  validate,
  execute,
  subscribe,
  plugins: [
    // ... other plugins ...
    useResolve(),
  ],
});
```

#### 2. Drop `useTiming` plugin

This plugin dependended on tracing the schema so we no longer support this out of the box. At this moment we do not have any alternative. We recommned using more advanced tracing solution. If you want to use this feel free to send in a pull request for new plugin!

#### 3. Remove `EnvelopError`

To keep the core agnostic from a specific implementation we no longer provide the `EnvelopError` class. To ensure an error is `GraphQLError` envelop check if it an `instanceOf Error` and the name of error is `GraphQLError`. We provide a helper utility `isGraphQLError` to check if an error is a `GraphQLError`.

### 3. Remove `useAsyncSchema` plugin

This was a mistake from beginning as we cannot asynchronously `validate` and `parse` since with [`graphql`](https://github.com/graphql/graphql-js) these functions are synchronous in nature.

You should first load your schema and then create the envelop instance and pass the schema to it.

```ts
import { envelop, useSchema } from '@envelop/core'
import { parse, validate, execute, subscribe } from 'graphql'

// this assume you are running latest node js version where top-level await is supported
const schema = await loadSchema()

const getEnveloped = envelop({
  parse,
  validate,
  execute,
  subscribe,
  plugins: [useSchema(schema)]
})
```

### 4. Rename `useLazyLoadedSchema` to `useSchemaByContext`

Oringinal name was very misleading since lazy loading could mean it can be asynchronous in nature. This plugin was renamed to better reflect its purpose. It is now called `useSchemaByContext`

### 5. Remove `enableIf` utility

This utility was used to enable plugins conditionally. For a better developer experience we have dropped this utility and favor more type safe way to conditionally enable plugins.

```diff
- import { envelop, useMaskedErrors, enableIf } from '@envelop/core'
+ import { envelop, useMaskedErrors } from '@envelop/core'
import { parse, validate, execute, subscribe } from 'graphql'

const isProd = process.env.NODE_ENV === 'production'

const getEnveloped = envelop({
 parse,
 validate,
 execute,
 subscribe,
 plugins: [
  // This plugin is enabled only in production
-  enableIf(isProd, useMaskedErrors())
+  isProd && useMaskedErrors()
 ]
})
```

### 6. Update options for `useMaskedErrors` plugin

- We _removed_ `handleValidationErrors` and `handleParseErrors` options since ONLY masking validation errors OR ONLY disabling introspection errors does not make sense, as both can be abused for reverse-engineering the GraphQL schema (see https://github.com/nikitastupin/clairvoyance for reverse-engineering the schema based on validation error suggestions). Instead you should use `useErrorHandler` plugin where you can access each phase and decide what to do with the error.
- Renamed `formatError` to `maskError`

### 7. Drop support for Node.js v12

Node.js v12 is no longer supported by the Node.js team. https://github.com/nodejs/Release/#end-of-life-releases
